<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neighborhood Intel Station</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Space+Grotesk:wght@400;500;600;700&family=Oxanium:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e14;
    --bg-secondary: #111720;
    --bg-card: #151c28;
    --bg-card-hover: #1a2233;
    --border: #1e2a3a;
    --border-glow: #2d4a6f;
    --text-primary: #e4e8ef;
    --text-secondary: #7a8ba3;
    --text-dim: #4a5568;
    --accent-cyan: #00d4ff;
    --accent-green: #00ff88;
    --accent-amber: #ffb800;
    --accent-red: #ff3355;
    --accent-purple: #8855ff;
    --accent-blue: #3388ff;
    --satellite-glow: #00d4ff33;
    --weather-glow: #00ff8833;
    --mesh-glow: #ffb80033;
    --rf-glow: #8855ff33;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Oxanium', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0, 212, 255, 0.008) 2px,
      rgba(0, 212, 255, 0.008) 4px
    );
    pointer-events: none;
    z-index: 1000;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
      radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(0, 255, 136, 0.02) 0%, transparent 50%),
      radial-gradient(circle at 50% 80%, rgba(136, 85, 255, 0.02) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
  }

  .header {
    padding: 20px 30px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.04) 0%, transparent 100%);
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-icon {
    width: 40px; height: 40px;
    border: 2px solid var(--accent-cyan);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    box-shadow: 0 0 20px var(--satellite-glow);
    animation: pulse-glow 3s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 15px var(--satellite-glow); }
    50% { box-shadow: 0 0 30px var(--satellite-glow), 0 0 60px rgba(0, 212, 255, 0.1); }
  }

  .header h1 {
    font-family: 'Oxanium', sans-serif;
    font-weight: 700;
    font-size: 1.3rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .header-right {
    display: flex; align-items: center; gap: 20px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }
  .status-dot.online { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
  .status-dot.offline { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
  .status-dot.waiting { background: var(--accent-amber); box-shadow: 0 0 8px var(--accent-amber); animation: blink 1.5s infinite; }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 16px;
    padding: 20px 30px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  .card:hover {
    background: var(--bg-card-hover);
    border-color: var(--border-glow);
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    border-radius: 12px 12px 0 0;
  }

  .card-satellite::before { background: linear-gradient(90deg, var(--accent-cyan), transparent); }
  .card-weather::before { background: linear-gradient(90deg, var(--accent-green), transparent); }
  .card-mesh::before { background: linear-gradient(90deg, var(--accent-amber), transparent); }
  .card-rf::before { background: linear-gradient(90deg, var(--accent-purple), transparent); }
  .card-epaper::before { background: linear-gradient(90deg, var(--accent-blue), transparent); }
  .card-alerts::before { background: linear-gradient(90deg, var(--accent-red), transparent); }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .card-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-secondary);
  }

  .card-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    padding: 3px 8px;
    border-radius: 4px;
    letter-spacing: 1px;
  }
  .badge-live { background: rgba(0, 255, 136, 0.15); color: var(--accent-green); }
  .badge-waiting { background: rgba(255, 184, 0, 0.15); color: var(--accent-amber); }
  .badge-offline { background: rgba(255, 51, 85, 0.15); color: var(--accent-red); }

  /* Weather Card */
  .weather-main {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 16px;
  }

  .weather-temp {
    font-size: 3rem;
    font-weight: 700;
    line-height: 1;
    font-family: 'Oxanium', sans-serif;
  }

  .weather-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .weather-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .weather-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .weather-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--text-primary);
  }

  /* Satellite Card */
  .sat-image-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    height: 160px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    overflow: hidden;
    position: relative;
  }

  .sat-image-container img {
    width: 100%; height: 100%;
    object-fit: cover;
  }

  .sat-placeholder {
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    text-align: center;
  }

  .sat-next-pass {
    background: rgba(0, 212, 255, 0.08);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 8px;
    padding: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
  }

  .sat-countdown {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-cyan);
    font-family: 'Oxanium', sans-serif;
  }

  /* Meshtastic Card */
  .mesh-nodes {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .mesh-node {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
  }

  .mesh-node-name { color: var(--accent-amber); }
  .mesh-node-info { color: var(--text-secondary); }

  .mesh-message-box {
    margin-top: 12px;
    display: flex;
    gap: 8px;
  }

  .mesh-input {
    flex: 1;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    outline: none;
  }
  .mesh-input:focus { border-color: var(--accent-amber); }

  /* RF Heatmap Card */
  .rf-heatmap {
    height: 150px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
  }

  .rf-canvas {
    width: 100%;
    height: 100%;
  }

  .rf-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    color: var(--text-dim);
  }

  /* e-Paper Card */
  .epaper-preview {
    background: #e8e4d8;
    border: 2px solid var(--border);
    border-radius: 8px;
    height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    position: relative;
  }

  .epaper-preview-text {
    color: #333;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    text-align: center;
  }

  .btn {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    padding: 8px 16px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.2s ease;
  }
  .btn:hover { border-color: var(--accent-cyan); background: rgba(0, 212, 255, 0.1); }
  .btn-primary {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 255, 136, 0.2));
    border-color: var(--accent-cyan);
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.3), rgba(0, 255, 136, 0.3));
    box-shadow: 0 0 20px var(--satellite-glow);
  }

  .btn-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Activity Log */
  .card-wide { grid-column: span 3; }

  .activity-log {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    max-height: 120px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .log-entry {
    display: flex;
    gap: 12px;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .log-entry:hover { background: var(--bg-secondary); }

  .log-time { color: var(--text-dim); white-space: nowrap; }
  .log-source { width: 70px; font-weight: 500; }
  .log-source.sat { color: var(--accent-cyan); }
  .log-source.wx { color: var(--accent-green); }
  .log-source.mesh { color: var(--accent-amber); }
  .log-source.rf { color: var(--accent-purple); }
  .log-source.sys { color: var(--text-secondary); }
  .log-msg { color: var(--text-secondary); }

  /* Config Panel */
  .config-section {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .config-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
  }

  .config-label { color: var(--text-secondary); }
  .config-value { color: var(--accent-cyan); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg-secondary); }
  ::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 2px; }

  /* Responsive */
  @media (max-width: 1000px) {
    .dashboard { grid-template-columns: 1fr 1fr; }
    .card-wide { grid-column: span 2; }
  }
  @media (max-width: 650px) {
    .dashboard { grid-template-columns: 1fr; }
    .card-wide { grid-column: span 1; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo-icon">ðŸ“¡</div>
    <div>
      <h1>Neighborhood Intel Station</h1>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-dim); margin-top: 2px; letter-spacing: 1px;">
        LEAGUE CITY, TX â€” 29.4953Â°N, 95.1547Â°W
      </div>
    </div>
  </div>
  <div class="header-right">
    <span id="clock"></span>
    <span><span class="status-dot online"></span>SDR Node</span>
    <span><span class="status-dot online"></span>e-Paper</span>
    <span><span class="status-dot waiting"></span>Meshtastic</span>
  </div>
</div>

<div class="dashboard">

  <!-- SATELLITE CARD -->
  <div class="card card-satellite">
    <div class="card-header">
      <span class="card-title">ðŸ›° NOAA Satellite</span>
      <span class="card-badge badge-waiting" id="sat-badge">WAITING</span>
    </div>
    <div class="sat-image-container" id="sat-image-box">
      <div class="sat-placeholder" id="sat-placeholder">
        No satellite image yet<br>
        <span style="font-size: 0.6rem; color: var(--text-dim);">Waiting for next pass...</span>
      </div>
    </div>
    <div class="sat-next-pass">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="color: var(--text-secondary); margin-bottom: 4px;">NEXT PASS</div>
          <div id="sat-next-name" style="color: var(--accent-cyan);">NOAA 15</div>
          <div id="sat-next-time" style="color: var(--text-dim); font-size: 0.65rem;">00:23 UTC â€” 6:23 PM CST</div>
        </div>
        <div style="text-align: right;">
          <div style="color: var(--text-secondary); margin-bottom: 4px;">COUNTDOWN</div>
          <div class="sat-countdown" id="sat-countdown">--:--</div>
          <div id="sat-max-el" style="color: var(--text-dim); font-size: 0.65rem;">Max El: 44.2Â°</div>
        </div>
      </div>
    </div>
  </div>

  <!-- WEATHER CARD -->
  <div class="card card-weather">
    <div class="card-header">
      <span class="card-title">ðŸŒ¤ Weather Station</span>
      <span class="card-badge badge-live" id="wx-badge">LIVE</span>
    </div>
    <div class="weather-main">
      <div class="weather-temp" id="wx-temp">--Â°</div>
      <div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);" id="wx-condition">Loading...</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-dim);" id="wx-feels">Feels like --Â°</div>
      </div>
    </div>
    <div class="weather-details">
      <div class="weather-item">
        <span class="weather-label">Humidity</span>
        <span class="weather-value" id="wx-humidity">--%</span>
      </div>
      <div class="weather-item">
        <span class="weather-label">Wind</span>
        <span class="weather-value" id="wx-wind">-- mph</span>
      </div>
      <div class="weather-item">
        <span class="weather-label">Pressure</span>
        <span class="weather-value" id="wx-pressure">-- inHg</span>
      </div>
      <div class="weather-item">
        <span class="weather-label">Dew Point</span>
        <span class="weather-value" id="wx-dewpoint">--Â°F</span>
      </div>
      <div class="weather-item">
        <span class="weather-label">Rain Today</span>
        <span class="weather-value" id="wx-rain">--"</span>
      </div>
      <div class="weather-item">
        <span class="weather-label">UV Index</span>
        <span class="weather-value" id="wx-uv">--</span>
      </div>
      <div class="weather-item">
        <span class="weather-label">Solar Rad</span>
        <span class="weather-value" id="wx-solar">-- W/mÂ²</span>
      </div>
      <div class="weather-item">
        <span class="weather-label">Indoor</span>
        <span class="weather-value" id="wx-indoor">--Â°F</span>
      </div>
    </div>
    <div class="config-section">
      <div class="config-row">
        <span class="config-label">Station</span>
        <span class="config-value">WS-2902</span>
      </div>
      <div class="config-row">
        <span class="config-label">Last Update</span>
        <span class="config-value" id="wx-updated">--</span>
      </div>
    </div>
  </div>

  <!-- MESHTASTIC CARD -->
  <div class="card card-mesh">
    <div class="card-header">
      <span class="card-title">ðŸ“» Meshtastic Mesh</span>
      <span class="card-badge badge-waiting" id="mesh-badge">1 NODE</span>
    </div>
    <ul class="mesh-nodes" id="mesh-nodes">
      <li class="mesh-node">
        <span class="mesh-node-name">Danimal (Danl)</span>
        <span class="mesh-node-info">Heltec V4 â€” 76%</span>
      </li>
    </ul>
    <div style="margin-top: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-dim);">
      <div style="margin-bottom: 8px;">Recent Messages:</div>
      <div id="mesh-messages" style="max-height: 60px; overflow-y: auto; color: var(--text-secondary);">
        <div>No messages yet</div>
      </div>
    </div>
    <div class="mesh-message-box">
      <input class="mesh-input" id="mesh-input" placeholder="Send message to mesh..." />
      <button class="btn" onclick="sendMeshMessage()">Send</button>
    </div>
  </div>

  <!-- RF SPECTRUM CARD -->
  <div class="card card-rf">
    <div class="card-header">
      <span class="card-title">ðŸ“Š RF Spectrum</span>
      <span class="card-badge badge-offline" id="rf-badge">NOT CONFIGURED</span>
    </div>
    <div class="rf-heatmap">
      <canvas class="rf-canvas" id="rf-canvas"></canvas>
    </div>
    <div class="rf-labels">
      <span>25 MHz</span>
      <span>137 MHz</span>
      <span>433 MHz</span>
      <span>915 MHz</span>
      <span>1.3 GHz</span>
    </div>
    <div style="margin-top: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-dim); text-align: center;">
      Requires 2nd RTL-SDR + Discone antenna
    </div>
  </div>

  <!-- E-PAPER CARD -->
  <div class="card card-epaper">
    <div class="card-header">
      <span class="card-title">ðŸ–¥ e-Paper Display</span>
      <span class="card-badge badge-live" id="epaper-badge">CONNECTED</span>
    </div>
    <div class="epaper-preview" id="epaper-preview">
      <div class="epaper-preview-text">
        Waveshare 7.3" 6-Color<br>
        800Ã—480 â€” Last pushed: --
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="pushToEpaper('dashboard')">Push Dashboard</button>
      <button class="btn" onclick="pushToEpaper('satellite')">Push Sat Image</button>
      <button class="btn" onclick="pushToEpaper('weather')">Push Weather</button>
    </div>
    <div class="config-section">
      <div class="config-row">
        <span class="config-label">Node IP</span>
        <span class="config-value">192.168.1.220</span>
      </div>
      <div class="config-row">
        <span class="config-label">Refresh Time</span>
        <span class="config-value">~25 sec</span>
      </div>
    </div>
  </div>

  <!-- SYSTEM STATUS CARD -->
  <div class="card card-alerts">
    <div class="card-header">
      <span class="card-title">âš¡ System Status</span>
      <span class="card-badge badge-live">NOMINAL</span>
    </div>
    <div class="config-row">
      <span class="config-label">SDR Node</span>
      <span class="config-value">192.168.1.253 <span class="status-dot online"></span></span>
    </div>
    <div class="config-row">
      <span class="config-label">e-Paper Node</span>
      <span class="config-value">192.168.1.220 <span class="status-dot online"></span></span>
    </div>
    <div class="config-row">
      <span class="config-label">RTL-SDR</span>
      <span class="config-value">Blog V4 â€” R828D</span>
    </div>
    <div class="config-row">
      <span class="config-label">Antenna</span>
      <span class="config-value">V-Dipole 137MHz</span>
    </div>
    <div class="config-row">
      <span class="config-label">Meshtastic</span>
      <span class="config-value">Heltec V4 â€” USB</span>
    </div>
    <div class="config-row">
      <span class="config-label">Weather</span>
      <span class="config-value">WS-2902 â€” API</span>
    </div>
    <div class="config-section">
      <div class="btn-row">
        <button class="btn" onclick="refreshAll()">Refresh All</button>
        <button class="btn" onclick="updateTLE()">Update TLE</button>
      </div>
    </div>
  </div>

  <!-- ACTIVITY LOG -->
  <div class="card card-wide" style="border-top: 2px solid var(--border);">
    <div class="card-header">
      <span class="card-title">ðŸ“‹ Activity Log</span>
      <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-dim);">LIVE FEED</span>
    </div>
    <div class="activity-log" id="activity-log">
      <div class="log-entry">
        <span class="log-time">--:--:--</span>
        <span class="log-source sys">SYSTEM</span>
        <span class="log-msg">Neighborhood Intel Station initializing...</span>
      </div>
    </div>
  </div>

</div>

<script>
  // ============================================
  // CONFIGURATION
  // ============================================
  const CONFIG = {
    weather: {
      apiKey: 'ea6f024843dd42c39e23c3484016fdafd203909dae1a40e5811aa1db33f2bc7b',
      appKey: 'dea6391c2ada481389e3d7eec5d3598f2c8da4d8a19c48bda824b8b40c0c9489',
      pollInterval: 300000  // 5 minutes
    },
    sdr: {
      host: '192.168.1.253',
      user: 'sdr',
      imageDir: '/home/sdr/noaa_reception/images/'
    },
    epaper: {
      host: '192.168.1.220',
      user: 'epaper'
    },
    nextPass: {
      satellite: 'NOAA 15',
      utcTime: '2026-02-17T00:23:57Z',
      maxEl: 44.2
    }
  };

  // ============================================
  // CLOCK
  // ============================================
  function updateClock() {
    const now = new Date();
    const cst = now.toLocaleString('en-US', { timeZone: 'America/Chicago', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    const utc = now.toISOString().substring(11, 19);
    document.getElementById('clock').textContent = `CST ${cst} | UTC ${utc}`;
  }
  setInterval(updateClock, 1000);
  updateClock();

  // ============================================
  // SATELLITE COUNTDOWN
  // ============================================
  function updateCountdown() {
    const now = new Date();
    const passTime = new Date(CONFIG.nextPass.utcTime);
    const diff = passTime - now;

    if (diff <= 0) {
      document.getElementById('sat-countdown').textContent = 'NOW!';
      document.getElementById('sat-badge').textContent = 'RECORDING';
      document.getElementById('sat-badge').className = 'card-badge badge-live';
      return;
    }

    const hours = Math.floor(diff / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    const secs = Math.floor((diff % 60000) / 1000);

    let display = '';
    if (hours > 0) display = `${hours}h ${mins}m`;
    else if (mins > 0) display = `${mins}m ${secs}s`;
    else display = `${secs}s`;

    document.getElementById('sat-countdown').textContent = display;
  }
  setInterval(updateCountdown, 1000);
  updateCountdown();

  // ============================================
  // WEATHER
  // ============================================
  async function fetchWeather() {
    try {
      const url = `https://rt.ambientweather.net/v1/devices?apiKey=${CONFIG.weather.apiKey}&applicationKey=${CONFIG.weather.appKey}`;
      const response = await fetch(url);
      const data = await response.json();

      if (data && data.length > 0) {
        const wx = data[0].lastData;

        document.getElementById('wx-temp').textContent = `${Math.round(wx.tempf)}Â°`;
        document.getElementById('wx-feels').textContent = `Feels like ${Math.round(wx.feelsLike)}Â°`;
        document.getElementById('wx-humidity').textContent = `${wx.humidity}%`;
        document.getElementById('wx-wind').textContent = `${wx.windspeedmph} mph`;
        document.getElementById('wx-pressure').textContent = `${wx.baromrelin.toFixed(2)} inHg`;
        document.getElementById('wx-dewpoint').textContent = `${Math.round(wx.dewPoint)}Â°F`;
        document.getElementById('wx-rain').textContent = `${wx.dailyrainin}"`;
        document.getElementById('wx-uv').textContent = wx.uv;
        document.getElementById('wx-solar').textContent = `${wx.solarradiation} W/mÂ²`;
        document.getElementById('wx-indoor').textContent = `${Math.round(wx.tempinf)}Â°F`;

        // Determine condition
        let condition = 'Clear';
        if (wx.hourlyrainin > 0) condition = 'ðŸŒ§ Raining';
        else if (wx.humidity > 90) condition = 'ðŸŒ« Foggy';
        else if (wx.windspeedmph > 15) condition = 'ðŸ’¨ Windy';
        else if (wx.uv > 6) condition = 'â˜€ï¸ Sunny';
        else if (wx.solarradiation > 0) condition = 'ðŸŒ¤ Partly Cloudy';
        else condition = 'ðŸŒ™ Clear Night';
        document.getElementById('wx-condition').textContent = condition;

        const updated = new Date(wx.dateutc);
        document.getElementById('wx-updated').textContent = updated.toLocaleTimeString('en-US', { timeZone: 'America/Chicago' });

        addLog('wx', `Weather updated: ${Math.round(wx.tempf)}Â°F, ${wx.humidity}% humidity`);
      }
    } catch (err) {
      addLog('sys', `Weather fetch error: ${err.message}`);
      document.getElementById('wx-badge').textContent = 'ERROR';
      document.getElementById('wx-badge').className = 'card-badge badge-offline';
    }
  }

  // ============================================
  // RF HEATMAP VISUALIZATION (demo)
  // ============================================
  function drawRFHeatmap() {
    const canvas = document.getElementById('rf-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);

    const w = canvas.offsetWidth;
    const h = canvas.offsetHeight;

    // Generate noise pattern with some hotspots
    for (let y = 0; y < h; y += 2) {
      for (let x = 0; x < w; x += 2) {
        let intensity = Math.random() * 30;

        // FM broadcast hotspot (around 20% of width)
        if (Math.abs(x / w - 0.15) < 0.05) intensity += 40 + Math.random() * 30;
        // 137 MHz NOAA (around 25%)
        if (Math.abs(x / w - 0.22) < 0.02) intensity += 20 + Math.random() * 20;
        // 433 MHz ISM (around 55%)
        if (Math.abs(x / w - 0.55) < 0.03) intensity += 30 + Math.random() * 25;
        // 915 MHz LoRa (around 78%)
        if (Math.abs(x / w - 0.78) < 0.02) intensity += 15 + Math.random() * 15;

        intensity = Math.min(intensity, 100);

        const r = intensity > 60 ? Math.min(255, intensity * 3) : 0;
        const g = intensity > 30 ? Math.min(255, (intensity - 30) * 4) : 0;
        const b = Math.min(255, intensity * 2.5);

        ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
        ctx.fillRect(x, y, 2, 2);
      }
    }
  }

  // ============================================
  // ACTIVITY LOG
  // ============================================
  function addLog(source, message) {
    const log = document.getElementById('activity-log');
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour12: false });

    const sourceLabels = {
      sat: 'NOAA', wx: 'WEATHER', mesh: 'MESH', rf: 'RF', sys: 'SYSTEM'
    };

    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `
      <span class="log-time">${time}</span>
      <span class="log-source ${source}">${sourceLabels[source] || source}</span>
      <span class="log-msg">${message}</span>
    `;

    log.insertBefore(entry, log.firstChild);

    // Keep max 50 entries
    while (log.children.length > 50) {
      log.removeChild(log.lastChild);
    }
  }

  // ============================================
  // ACTIONS
  // ============================================
  function pushToEpaper(mode) {
    addLog('sys', `Pushing ${mode} view to e-Paper display...`);
    // In full implementation, this would generate an image and SCP it
    alert(`Push ${mode} to e-Paper: This requires the Python backend to generate and SCP the image to 192.168.1.220`);
  }

  function sendMeshMessage() {
    const input = document.getElementById('mesh-input');
    const msg = input.value.trim();
    if (!msg) return;

    addLog('mesh', `Sent: "${msg}"`);
    input.value = '';
    // In full implementation: python -m meshtastic --sendtext "msg"
    alert(`Send via Meshtastic: "${msg}"\nRequires Python backend to run: python -m meshtastic --sendtext "${msg}"`);
  }

  function refreshAll() {
    addLog('sys', 'Manual refresh triggered');
    fetchWeather();
    drawRFHeatmap();
  }

  function updateTLE() {
    addLog('sat', 'TLE update requested â€” SSH to SDR node...');
    alert('TLE Update: Requires SSH to 192.168.1.253 to run: python3 noaa_capture.py --update-tle');
  }

  // ============================================
  // INIT
  // ============================================
  addLog('sys', 'Neighborhood Intel Station online');
  addLog('sys', 'SDR Node connected â€” RTL-SDR Blog V4 detected');
  addLog('sys', 'e-Paper Node connected â€” Waveshare 7.3" ready');
  addLog('mesh', 'Meshtastic connected â€” Heltec V4 (Danimal)');
  addLog('sat', `Next pass: ${CONFIG.nextPass.satellite} at ${CONFIG.nextPass.utcTime}`);

  fetchWeather();
  setInterval(fetchWeather, CONFIG.weather.pollInterval);

  // Draw RF heatmap demo
  setTimeout(drawRFHeatmap, 500);
  window.addEventListener('resize', drawRFHeatmap);
</script>

</body>
</html>
